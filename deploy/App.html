<!DOCTYPE html>
<html>
<head>
    <title>rally_backlog_health</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",_getProjectList:function(){return["Austin Avengers - RD","Mountaineers - RD","Next Gen Merchandising - RD","Prestige Worldwide - RD","Money Train - RD","Quarantiners - RD","Tejas - RD (Snaplot / DigitalLot)","Phoenix - RD","Thundercats - RD"]},launch:function(){this._loadData()},_loadIterations:function(t){this.iterations_loaded=!0,this._loadFeaturesData(t)},_loadFeatures:function(t){this.features_loaded=!0,this._loadFeatureGrid(t),this._loadEpicsData()},_loadEpics:function(t){this.epics_loaded=!0,this._loadEpicsGrid(t),this._loadUserStoryData()},_getGroupedFeatureModel:function(){return console.log("_getGroupedFeatureModel"),Ext.define("feature_model",{extend:"Ext.data.Model",fields:[{name:"project",type:"string"},{name:"teamsprints",type:"float"},{name:"targetteamsprints",type:"string"},{name:"ratio",type:"string"}]})},_getEpicModel:function(){return Ext.define("epic_model",{extend:"Ext.data.Model",fields:[{name:"project",type:"string"},{name:"teamsprints",type:"float"},{name:"targetteamsprints",type:"string"},{name:"ratio",type:"string"}]})},_getGroupedUserStoryModel:function(){return Ext.define("rbh_model",{extend:"Ext.data.Model",fields:[{name:"project",type:"string"},{name:"storycount",type:"int"},{name:"totalestimate",type:"int"},{name:"averagevelocity",type:"int"},{name:"targetdepth",type:"int"},{name:"ratio",type:"string"}]})},_getEstimateSum:function(t){for(var e=0,a=0;a<t.length;a++)e+=t[a].data.PlanEstimate;return e},_getEpicTeamSprints:function(t){for(var e=0,a=0;a<t.data.items.length;a++)if(t.data.items[a].get("PreliminaryEstimate"))switch(t.data.items[a].get("PreliminaryEstimate").Name){case"XS":e+=1;break;case"S":e+=1.5;break;case"M":e+=3.5;break;case"L":e+=6;break;case"XL":e+=9}return e},_getFeatureTeamSprints:function(t){var e=0;console.log("_getFeatureTeamSprints",t);for(var a=0;a<t.length;a++)switch(console.log("Adding Feature Sprints",t[a].data.PreliminaryEstimate.Name),t[a].data.PreliminaryEstimate.Name){case"XS":e+=.5;break;case"S":e+=1;break;case"M":e+=2.5;break;case"L":e+=4;break;case"XL":e+=6}return e},_getVelocityForProject:function(t){for(var e,a=0,r=this.iterationDataStore.getGroups(),o=0;o<r.length;o++)if(r[o].name===t){e=r[o].children.length;for(var i=0;i<e;i++)a+=r[o].children[i].get("PlanEstimate")}return a/e},_buildProjectFeatureJson:function(t,e){console.log("_buildProjectFeatureJson",t,e);var a={};if(null===e)return a.project=t,a.teamsprints=0,a.targetteamsprints=6,a.ratio="0%",a;a.project=t,a.teamsprints=this._getFeatureTeamSprints(e),a.targetteamsprints=6;var r=a.teamsprints/a.targetteamsprints;return r=isFinite(r)?Math.round(100*r).toString()+"%":"-",a.ratio=r,console.log("_buildProjectFeatureJason-RETURN",a),a},_buildProjectUserStoryJson:function(t,e){var a={};a.project=t,a.storycount=e.length,a.totalestimate=this._getEstimateSum(e),a.averagevelocity=Math.round(this._getVelocityForProject(t)),a.targetdepth=2*a.averagevelocity;var r=a.totalestimate/a.targetdepth;return r=isFinite(r)?Math.round(100*r).toString()+"%":"-",a.ratio=r,a},_buildFeatureJson:function(t){console.log("_buildFeatureJson",t);for(var e={projects:[]},a=this._getProjectList(),r=[],o=0;o<t.length;o++)e.projects.push(this._buildProjectFeatureJson(t[o].name,t[o].children)),r.push(t[o].name);for(var i=0;i<a.length;i++)r.includes(a[i])||e.projects.push(this._buildProjectFeatureJson(a[i],null));return console.log("_buildFeatureJson-RETURN",e),e},_buildEpicJson:function(t){console.log("_buildEpicJson",t);var e={epics:{}};return e.epics.project="Merchandising - RD",e.epics.targetteamsprints=56,e.epics.teamsprints=this._getEpicTeamSprints(t),e.epics.ratio=Math.round(e.epics.teamsprints/e.epics.targetteamsprints*100).toString()+"%",e},_buildUserStoryJson:function(t){for(var e={projects:[]},a=0;a<t.length;a++)e.projects.push(this._buildProjectUserStoryJson(t[a].name,t[a].children));return e},_getFeatureStore:function(t){var e=this._buildFeatureJson(t);return Ext.create("Ext.data.JsonStore",{model:this._getGroupedFeatureModel(),autoLoad:!0,data:e,proxy:{type:"memory",reader:{type:"json",root:"projects"}}})},_getEpicStore:function(t){console.log("_getEpicStore",t);var e=this._buildEpicJson(t);return Ext.create("Ext.data.JsonStore",{model:this._getEpicModel(),autoLoad:!0,data:e,proxy:{type:"memory",reader:{type:"json",root:"epics"}}})},_getUserStoryStore:function(t){var e=this._buildUserStoryJson(t);return Ext.create("Ext.data.JsonStore",{model:this._getGroupedUserStoryModel(),autoLoad:!0,data:e,proxy:{type:"memory",reader:{type:"json",root:"projects"}}})},_epicFilters:function(){var t=Ext.create("Rally.data.wsapi.Filter",{property:"Project.Name",operator:"=",value:"Merchandising - RD"}),e=Ext.create("Rally.data.wsapi.Filter",{property:"Project.Name",operator:"=",value:"Next Gen Merchandising - RD"}).or(t),a=Ext.create("Rally.data.wsapi.Filter",{property:"State",operator:"=",value:"Feature Planning"}),r=Ext.create("Rally.data.wsapi.Filter",{property:"State",operator:"=",value:"Prioritized Backlog"}),o=a.or(r);return console.log("EPIC FILTER: ",e.and(o).toString()),e.and(o)},_featureFilters:function(){return Ext.create("Rally.data.wsapi.Filter",{property:"State",operator:"=",value:"Ready"})},_iterationFilters:function(){var t=new Date,e=new Date;e.setDate(t.getDate()-90);var a=Ext.create("Rally.data.wsapi.Filter",{property:"StartDate",operator:">=",value:e}),r=Ext.create("Rally.data.wsapi.Filter",{property:"EndDate",operator:"<=",value:t}),o=a.and(r);return console.log(o.toString()),o},_defaultFilters:function(){var t=Ext.create("Rally.data.wsapi.Filter",{property:"ScheduleState",operator:"=",value:"Defined"}),e=Ext.create("Rally.data.wsapi.Filter",{property:"ScheduleState",operator:"=",value:"Idea"});return Ext.create("Rally.data.wsapi.Filter",{property:"PlanEstimate",operator:">",value:0}).and(e.or(t))},_loadData:function(){this._loadIterationData()},_loadIterationData:function(){var t=this._iterationFilters();this.iterationDataStore=Ext.create("Rally.data.wsapi.Store",{model:"Iteration",autoLoad:!0,filters:t,groupField:"Project",groupDir:"ASC",listeners:{scope:this,load:this._loadIterations},getGroupString:function(t){var e=t.get("Project");return e&&e._refObjectName||"No Project"},fetch:["Name","StartDate","EndDate","Project","PlanEstimate","PlannedVelocity"]})},_loadEpicsData:function(){var t=this._epicFilters();this.epicDataStore=Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem/Epic",autoLoad:!0,filters:t,listeners:{scope:this,load:this._loadEpics},fetch:["Name","FormattedID","Project","State","PreliminaryEstimate","PreliminaryEstimateValue"]})},_loadFeaturesData:function(){var t=this._featureFilters();this.featureDataStore=Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem/Feature",autoLoad:!0,filters:t,groupField:"Project",groupDir:"ASC",pageSize:1e3,listeners:{scope:this,load:this._loadFeatures},getGroupString:function(t){var e=t.get("Project");return e&&e._refObjectName||"No Project"},fetch:["Project","Name","FormattedID","State","PreliminaryEstimate","PreliminaryEstimateValue"]})},_loadUserStoryData:function(){var t=this._defaultFilters();this.userStoryDataStore=Ext.create("Rally.data.wsapi.Store",{model:"User Story",autoLoad:!0,filters:t,groupField:"Project",groupDir:"ASC",pageSize:1e3,listeners:{scope:this,load:this._loadUserStoryGrid},getGroupString:function(t){var e=t.get("Project");return e&&e._refObjectName||"No Project"},fetch:["Project","Name","ScheduleState","PlanEstimate"]})},_colorcode:function(t){var e=parseInt(t);return e>=90?Ext.String.format('<p style="color:green">{0}</p>',t):e>=50?Ext.String.format('<p style="color:orange">{0}</p>',t):Ext.String.format('<p style="color:red">{0}</p>',t)},_loadEpicsGrid:function(t){console.log("_loadEpicsGrid",t);var e=this._getEpicStore(t),a=Ext.create("Ext.grid.Panel",{title:"Epic Backlog Health",store:e,columns:[{text:"Project",dataIndex:"project"},{text:"Team Sprints",dataIndex:"teamsprints"},{text:"Target TS",dataIndex:"targetteamsprints"},{text:"Ratio",dataIndex:"ratio",renderer:this._colorcode}]});this.add(a)},_loadFeatureGrid:function(t){var e=this._getFeatureStore(t.getGroups()),a=Ext.create("Ext.grid.Panel",{title:"Feature Backlog Health",store:e,columns:[{text:"Project",dataIndex:"project"},{text:"Team Sprints",dataIndex:"teamsprints"},{text:"Target TS",dataIndex:"targetteamsprints"},{text:"Ratio",dataIndex:"ratio",renderer:this._colorcode}]});this.add(a)},_loadUserStoryGrid:function(t){var e=this._getUserStoryStore(t.getGroups()),a=Ext.create("Ext.grid.Panel",{title:"User Story Backlog Health",store:e,columns:[{text:"Project",dataIndex:"project"},{text:"Story Count",dataIndex:"storycount"},{text:"Story Points",dataIndex:"totalestimate"},{text:"Average Velocity",dataIndex:"averagevelocity"},{text:"Target Depth",dataIndex:"targetdepth"},{text:"Ratio Points to Target",dataIndex:"ratio",renderer:this._colorcode}]});this.add(a)}});

            Rally.launchApp('CustomApp', {
                name:"rally_backlog_health",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
