<!DOCTYPE html>
<html>
<head>
    <title>rally_backlog_health</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){this._loadData()},_getRallyBacklogHealthModel:function(){return Ext.define("rbh_model",{extend:"Ext.data.Model",fields:[{name:"project",type:"string"},{name:"storycount",type:"int"},{name:"totalestimate",type:"int"},{name:"averagevelocity",type:"int"},{name:"targetdepth",type:"int"},{name:"ratio",type:"string"}]})},_getEstimateSum:function(t){for(var e=0,a=0;a<t.length;a++)e+=t[a].data.PlanEstimate;return e},_buildProjectGroupJson:function(t,e){var a={};a.project=t,a.storycount=e.length,a.totalestimate=this._getEstimateSum(e),a.averagevelocity=Math.round(this._getVelocityForProject(t)),a.targetdepth=2*a.averagevelocity;var o=a.totalestimate/a.targetdepth;return o=isFinite(o)?Math.round(100*o).toString()+"%":"-",a.ratio=o,a},_buildJson:function(t){for(var e={projects:[]},a=0;a<t.length;a++)e.projects.push(this._buildProjectGroupJson(t[a].name,t[a].children));return e},_getRallyBacklogHealthStore:function(t){var e=this._buildJson(t);return Ext.create("Ext.data.JsonStore",{model:this._getRallyBacklogHealthModel(),autoLoad:!0,data:e,proxy:{type:"memory",reader:{type:"json",root:"projects"}}})},_getVelocityForProject:function(t){for(var e,a=0,o=this.iterationDataStore.getGroups(),r=0;r<o.length;r++)if(o[r].name===t){e=o[r].children.length;for(var i=0;i<e;i++)a+=o[r].children[i].get("PlanEstimate")}return a/e},_epicFilters:function(){},_iterationFilters:function(){var t=new Date,e=new Date;e.setDate(t.getDate()-90);var a=Ext.create("Rally.data.wsapi.Filter",{property:"StartDate",operator:">=",value:e}),o=Ext.create("Rally.data.wsapi.Filter",{property:"EndDate",operator:"<=",value:t}),r=a.and(o);return console.log(r.toString()),r},_featureFilters:function(){},_defaultFilters:function(){var t=Ext.create("Rally.data.wsapi.Filter",{property:"ScheduleState",operator:"=",value:"Defined"}),e=Ext.create("Rally.data.wsapi.Filter",{property:"ScheduleState",operator:"=",value:"Idea"});return Ext.create("Rally.data.wsapi.Filter",{property:"PlanEstimate",operator:">",value:0}).and(e.or(t))},_loadIterationData:function(){var t=this._iterationFilters();this.iterationDataStore=Ext.create("Rally.data.wsapi.Store",{model:"Iteration",autoLoad:!0,filters:t,groupField:"Project",groupDir:"ASC",listeners:{scope:this,load:this._loadIterations},getGroupString:function(t){var e=t.get("Project");return e&&e._refObjectName||"No Project"},fetch:["Name","StartDate","EndDate","Project","PlanEstimate","PlannedVelocity"]}),this._loadFeaturesData()},_loadFeaturesData:function(){this.featureDataStore=Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem/Feature",autoLoad:!0,listeners:{scope:this,load:this._loadFeatures},fetch:["Name","FormattedID","Project"]}),this._loadEpicsData()},_loadEpicsData:function(){this.epicDataStore=Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem/Epic",autoLoad:!0,listeners:{scope:this,load:this._loadEpics},fetch:["Name","FormattedID","Project"]}),this._loadUserStoryData()},_loadUserStoryData:function(){var t=this._defaultFilters();this.userStoryDataStore=Ext.create("Rally.data.wsapi.Store",{model:"User Story",autoLoad:!0,filters:t,groupField:"Project",groupDir:"DESC",pageSize:1e3,listeners:{scope:this,load:this._loadGrid},getGroupString:function(t){var e=t.get("Project");return e&&e._refObjectName||"No Project"},fetch:["Project","Name","ScheduleState","PlanEstimate"]})},_loadData:function(){this._loadIterationData()},_colorcode:function(t){var e=parseInt(t);return e>=90?Ext.String.format('<p style="color:green">{0}</p>',t):e>=50?Ext.String.format('<p style="color:orange">{0}</p>',t):Ext.String.format('<p style="color:red">{0}</p>',t)},_loadGrid:function(t){var e=this._getRallyBacklogHealthStore(t.getGroups()),a=Ext.create("Ext.grid.Panel",{title:"Backlog Health",store:e,columns:[{text:"Project",dataIndex:"project"},{text:"Story Count",dataIndex:"storycount"},{text:"Story Points",dataIndex:"totalestimate"},{text:"Average Velocity",dataIndex:"averagevelocity"},{text:"Target Depth",dataIndex:"targetdepth"},{text:"Ratio Points to Target",dataIndex:"ratio",renderer:this._colorcode}]});this.add(a)},_loadIterations:function(t){console.log("ITERATIONS LOADED",t)},_loadFeatures:function(t){console.log("FEATURES LOADED: ",t)},_loadEpics:function(t){console.log("EPICS LOADED: ",t)}});

            Rally.launchApp('CustomApp', {
                name:"rally_backlog_health",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
