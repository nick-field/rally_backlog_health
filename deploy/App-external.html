<!DOCTYPE html>
<html>
<head>
    <title>rally_backlog_health</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",_getProjectList:function(){return["Austin Avengers - RD","Mountaineers - RD","Next Gen Merchandising - RD","Prestige Worldwide - RD","Money Train - RD","Quarantiners - RD","Tejas - RD (Snaplot / DigitalLot)","Phoenix - RD","Thundercats - RD"]},launch:function(){this.topPanel=Ext.create("Ext.Panel",{}),this.epicLegend=Ext.create("Ext.Panel",{html:"<p>56 is the total number of team sprints available for the train.</p><p>Epics included for this metric are those in Prioritized Backlog or Feature Planning with a Preliminary Estimate populated.</p><p>Green = 90% of the target is full.  Yellow = 50% - 90% of the target is full.  Red = < 50% of the target ts full.</p>"}),this.middlePanel=Ext.create("Ext.Panel",{}),this.featureLegend=Ext.create("Ext.Panel",{html:"<p>6 is the total number of team sprints per team (IP sprint not included).</p><p>Features included for this metric are those in Ready state with a Preliminary Estimate populated. Next Gen Merchandising represents any features not assigned to a specific team yet.  Next Gen Merch does not need to achieve the goal.</p><p>Green = 90% of the target is full.  Yellow = 50% - 90% of the target is full.  Red = < 50% of the target ts full.</p>"}),this.bottomPanel=Ext.create("Ext.Panel",{}),this.storyLegend=Ext.create("Ext.Panel",{html:"<p>The velocity for each team is the average of the past 90 days, and the target is twice that velocity.</p><p>Stories included for this metric are those in Idea or Defined state with a plan estimate.  </p><p>Green = 90% of the target is full.  Yellow = 50% - 90% of the target is full.  Red = < 50% of the target ts full.</p>"}),this.legendPanel=Ext.create("Ext.Panel",{html:"<h3>Legend</h3><p>TBD</p> "}),masterPanel=Ext.create("Ext.panel.Panel",{renderTo:Ext.getBody(),width:830,margin:20,border:!0,frame:!0,items:[this.topPanel,this.epicLegend,this.middlePanel,this.featureLegend,this.bottomPanel,this.storyLegend]}),this.add(masterPanel),this._loadData()},_loadIterations:function(t){this.iterations_loaded=!0,this._loadFeaturesData(t)},_loadFeatures:function(t){this.features_loaded=!0,this._loadFeatureGrid(t),this._loadEpicsData()},_loadEpics:function(t){this.epics_loaded=!0,this._loadEpicsGrid(t),this._loadUserStoryData()},_getGroupedFeatureModel:function(){return Ext.define("feature_model",{extend:"Ext.data.Model",fields:[{name:"project",type:"string"},{name:"teamsprints",type:"float"},{name:"targetteamsprints",type:"string"},{name:"ratio",type:"string"}]})},_getEpicModel:function(){return Ext.define("epic_model",{extend:"Ext.data.Model",fields:[{name:"project",type:"string"},{name:"teamsprints",type:"float"},{name:"targetteamsprints",type:"string"},{name:"ratio",type:"string"}]})},_getGroupedUserStoryModel:function(){return Ext.define("rbh_model",{extend:"Ext.data.Model",fields:[{name:"project",type:"string"},{name:"storycount",type:"int"},{name:"totalestimate",type:"int"},{name:"averagevelocity",type:"int"},{name:"targetdepth",type:"int"},{name:"ratio",type:"string"}]})},_getEstimateSum:function(t){for(var e=0,a=0;a<t.length;a++)e+=t[a].data.PlanEstimate;return e},_getEpicTeamSprints:function(t){for(var e=0,a=0;a<t.data.items.length;a++)if(t.data.items[a].get("PreliminaryEstimate"))switch(t.data.items[a].get("PreliminaryEstimate").Name){case"XS":e+=1;break;case"S":e+=1.5;break;case"M":e+=3.5;break;case"L":e+=6;break;case"XL":e+=9}return e},_getFeatureTeamSprints:function(t){for(var e=0,a=0;a<t.length;a++)switch(t[a].data.PreliminaryEstimate.Name){case"XS":e+=.5;break;case"S":e+=1;break;case"M":e+=2.5;break;case"L":e+=4;break;case"XL":e+=6}return e},_getVelocityForProject:function(t){for(var e,a=0,r=this.iterationDataStore.getGroups(),i=0;i<r.length;i++)if(r[i].name===t){e=r[i].children.length;for(var o=0;o<e;o++)a+=r[i].children[o].get("PlanEstimate")}return a/e},_buildProjectFeatureJson:function(t,e){var a={};if(null===e)return a.project=t,a.teamsprints=0,a.targetteamsprints=6,a.ratio="0%",a;a.project=t,a.teamsprints=this._getFeatureTeamSprints(e),a.targetteamsprints=6;var r=a.teamsprints/a.targetteamsprints;return r=isFinite(r)?Math.round(100*r).toString()+"%":"-",a.ratio=r,a},_buildProjectUserStoryJson:function(t,e){var a={};a.project=t,a.storycount=e.length,a.totalestimate=this._getEstimateSum(e),a.averagevelocity=Math.round(this._getVelocityForProject(t)),a.targetdepth=2*a.averagevelocity;var r=a.totalestimate/a.targetdepth;return r=isFinite(r)?Math.round(100*r).toString()+"%":"-",a.ratio=r,a},_buildFeatureJson:function(t){for(var e={projects:[]},a=this._getProjectList(),r=[],i=0;i<t.length;i++)e.projects.push(this._buildProjectFeatureJson(t[i].name,t[i].children)),r.push(t[i].name);for(var o=0;o<a.length;o++)r.includes(a[o])||e.projects.push(this._buildProjectFeatureJson(a[o],null));return e},_buildEpicJson:function(t){var e={epics:{}};return e.epics.project="Merchandising - RD",e.epics.targetteamsprints=56,e.epics.teamsprints=this._getEpicTeamSprints(t),e.epics.ratio=Math.round(e.epics.teamsprints/e.epics.targetteamsprints*100).toString()+"%",e},_buildUserStoryJson:function(t){for(var e={projects:[]},a=0;a<t.length;a++)e.projects.push(this._buildProjectUserStoryJson(t[a].name,t[a].children));return e},_getFeatureStore:function(t){var e=this._buildFeatureJson(t);return Ext.create("Ext.data.JsonStore",{model:this._getGroupedFeatureModel(),autoLoad:!0,data:e,proxy:{type:"memory",reader:{type:"json",root:"projects"}}})},_getEpicStore:function(t){var e=this._buildEpicJson(t);return Ext.create("Ext.data.JsonStore",{model:this._getEpicModel(),autoLoad:!0,data:e,proxy:{type:"memory",reader:{type:"json",root:"epics"}}})},_getUserStoryStore:function(t){var e=this._buildUserStoryJson(t);return Ext.create("Ext.data.JsonStore",{model:this._getGroupedUserStoryModel(),autoLoad:!0,data:e,proxy:{type:"memory",reader:{type:"json",root:"projects"}}})},_epicFilters:function(){var t=Ext.create("Rally.data.wsapi.Filter",{property:"Project.Name",operator:"=",value:"Merchandising - RD"}),e=Ext.create("Rally.data.wsapi.Filter",{property:"Project.Name",operator:"=",value:"Next Gen Merchandising - RD"}).or(t),a=Ext.create("Rally.data.wsapi.Filter",{property:"State",operator:"=",value:"Feature Planning"}),r=Ext.create("Rally.data.wsapi.Filter",{property:"State",operator:"=",value:"Prioritized Backlog"}),i=a.or(r);return e.and(i)},_featureFilters:function(){return Ext.create("Rally.data.wsapi.Filter",{property:"State",operator:"=",value:"Ready"})},_iterationFilters:function(){var t=new Date,e=new Date;e.setDate(t.getDate()-90);var a=Ext.create("Rally.data.wsapi.Filter",{property:"StartDate",operator:">=",value:e}),r=Ext.create("Rally.data.wsapi.Filter",{property:"EndDate",operator:"<=",value:t}),i=a.and(r);return console.log(i.toString()),i},_defaultFilters:function(){var t=Ext.create("Rally.data.wsapi.Filter",{property:"ScheduleState",operator:"=",value:"Defined"}),e=Ext.create("Rally.data.wsapi.Filter",{property:"ScheduleState",operator:"=",value:"Idea"});return Ext.create("Rally.data.wsapi.Filter",{property:"PlanEstimate",operator:">",value:0}).and(e.or(t))},_loadData:function(){this._loadIterationData()},_loadIterationData:function(){var t=this._iterationFilters();this.iterationDataStore=Ext.create("Rally.data.wsapi.Store",{model:"Iteration",autoLoad:!0,filters:t,groupField:"Project",groupDir:"ASC",listeners:{scope:this,load:this._loadIterations},getGroupString:function(t){var e=t.get("Project");return e&&e._refObjectName||"No Project"},fetch:["Name","StartDate","EndDate","Project","PlanEstimate","PlannedVelocity"]})},_loadEpicsData:function(){var t=this._epicFilters();this.epicDataStore=Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem/Epic",autoLoad:!0,filters:t,listeners:{scope:this,load:this._loadEpics},fetch:["Name","FormattedID","Project","State","PreliminaryEstimate","PreliminaryEstimateValue"]})},_loadFeaturesData:function(){var t=this._featureFilters();this.featureDataStore=Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem/Feature",autoLoad:!0,filters:t,groupField:"Project",groupDir:"ASC",pageSize:1e3,listeners:{scope:this,load:this._loadFeatures},getGroupString:function(t){var e=t.get("Project");return e&&e._refObjectName||"No Project"},fetch:["Project","Name","FormattedID","State","PreliminaryEstimate","PreliminaryEstimateValue"]})},_loadUserStoryData:function(){var t=this._defaultFilters();this.userStoryDataStore=Ext.create("Rally.data.wsapi.Store",{model:"User Story",autoLoad:!0,filters:t,groupField:"Project",groupDir:"ASC",pageSize:1e3,listeners:{scope:this,load:this._loadUserStoryGrid},getGroupString:function(t){var e=t.get("Project");return e&&e._refObjectName||"No Project"},fetch:["Project","Name","ScheduleState","PlanEstimate"]})},_colorcode:function(t){var e=parseInt(t);return e>=90?Ext.String.format('<p style="color:green">{0}</p>',t):e>=50?Ext.String.format('<p style="color:orange">{0}</p>',t):Ext.String.format('<p style="color:red">{0}</p>',t)},_loadEpicsGrid:function(t){var e=this._getEpicStore(t),a=Ext.create("Ext.grid.Panel",{title:"Epic Backlog Health",store:e,width:800,scrollable:!1,titleAlign:"center",margin:10,columns:[{text:"Project",dataIndex:"project",width:"25%"},{text:"Team Sprints",dataIndex:"teamsprints",width:"25%"},{text:"Target TS",dataIndex:"targetteamsprints",width:"25%"},{text:"Ratio",dataIndex:"ratio",renderer:this._colorcode,width:"25%"}]});this.topPanel.add(a)},_loadFeatureGrid:function(t){var e=this._getFeatureStore(t.getGroups()),a=Ext.create("Ext.grid.Panel",{title:"Feature Backlog Health",scrollable:!1,headerBorders:!1,store:e,width:800,margin:10,titleAlign:"center",columns:[{text:"Project",dataIndex:"project",width:"25%"},{text:"Team Sprints",dataIndex:"teamsprints",width:"25%"},{text:"Target TS",dataIndex:"targetteamsprints",width:"25%"},{text:"Ratio",dataIndex:"ratio",renderer:this._colorcode,width:"25%"}]});this.middlePanel.add(a)},_loadUserStoryGrid:function(t){var e=this._getUserStoryStore(t.getGroups()),a=Ext.create("Ext.grid.Panel",{title:"User Story Backlog Health",scrollable:!1,store:e,width:800,margin:10,titleAlign:"center",columns:[{text:"Project",dataIndex:"project",width:"20%"},{text:"Story Points",dataIndex:"totalestimate",width:"20%"},{text:"Average Velocity",dataIndex:"averagevelocity",width:"20%"},{text:"Target Depth",dataIndex:"targetdepth",width:"20%"},{text:"Ratio Points to Target",dataIndex:"ratio",renderer:this._colorcode,width:"20%"}]});this.bottomPanel.add(a)}});

            Rally.launchApp('CustomApp', {
                name:"rally_backlog_health",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
